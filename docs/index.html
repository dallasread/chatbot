<!DOCTYPE html>
<html>
<head>
    <title>Chatbot</title>

    <link rel="stylesheet" type="text/css" href="assets/application.min.css">
    <!-- <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css"> -->
    <!-- <link href="assets/imgs/app-logo.png" rel="apple-touch-icon"> -->

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
</head>
<body>
    <style type="text/css">
        body {
            background: #fff;
            margin-bottom: 150px;
        }

        @media (min-width: 640px) {
            body {
                padding-top: 50px;
            }
        }

        .pac-logo:after {
            background-image: none;
            height: 0;
        }
    </style>
    <div id="container" style="max-width: 640px; margin: 0 auto; "></div>
    <script src="assets/application.min.js"></script>
    <script type="text/javascript">
        function MailChimp(apiKey, listId) {
            var _ = this;

            _.apiKey = apiKey;
            _.listId = listId;

            return _;
        }

        MailChimp.prototype.buildMerge = function buildMerge(user, prefix) {
            var _ = this,
                str = '';

            prefix = prefix || '';

            for (var key in user) {
                if (typeof user[key] === 'object') {
                    str += _.buildMerge(user[key], prefix + key + '][');
                } else {
                    str += '&merge_vars[' + prefix + key + ']=' + encodeURIComponent(user[key]);
                }
            }

            return str;
        };

        MailChimp.prototype.buildUrl = function buildUrl() {
            var _ = this;
            return 'https://' + _.apiKey.split('-')[1] + '.api.mailchimp.com/2.0/lists/subscribe.json';
        };

        MailChimp.prototype.save = function save(user) {
            var _ = this,
                url = _.buildUrl() + '?';

            if (!user.EMAIL && !user.PHONE) return;

            if (!user.EMAIL || !user.EMAIL.length) {
                user.EMAIL = encodeURIComponent('phone+' + user.PHONE.replace(/\D/g, '') + '@growthengine.com');
            }

            url += '&apikey=' + _.apiKey;
            url += '&id=' + _.listId;
            url += '&email[email]=' + user.EMAIL;
            url += _.buildMerge(user);
            url += '&double_optin=' + false;
            url += '&send_welcome=' + false;

            window.Chatbot.ajax({
                url: url,
                async: false,
                method: 'POST',
                success: console.log,
                error: console.error
            });
        };
    </script>
    <script>
        var mc = new window.MailChimp('2b05c7345099231882fedc42ef350f84-us18', 'ec3f9d6009'),
            getPhone = {
                text: 'What is your phone number?',
                input: {
                    type: 'tel',
                    name: 'PHONE'
                }
            },
            bot = new window.Chatbot({
                ioConfig: {
                    gmaps: {
                        apiKey: 'AIzaSyDkJrJyW8E105NOz2pMzT8d9LBTKMpnlkY'
                    }
                },
                agent: {
                    name: 'Will Nelson',
                    company: 'HouseHelper',
                    avatar: 'http://growthengine.com/wp-content/uploads/2017/02/profile-pic-150x150.jpg'
                },
                onComplete: function onComplete() {
                    var _ = this;

                    _.addMessage({ text: 'üëç Thanks ‚Äì we will respond ASAP!' });

                    mc.save( _.get('user') );
                },
                onLeave: function onLeave() {
                    var _ = this;

                    mc.save( _.get('user') );
                },
                schema: {
                    text: 'Hi! I\'m here to help! What can we help you find?',
                    input: {
                        name: 'INTEREST',
                        choices: [
                            { text: '1 Bedroom' },
                            { text: '1 Bedroom + Den' },
                            { text: '2 Bedroom' },
                            { text: '3 Bedroom' },
                            { text: '4 Bedroom' }
                        ]
                    },
                    response: {
                        text: 'Great! I can definitely help.',
                        delayed: {
                            text: 'Which scenario best fits your needs?',
                            input: {
                                name: 'LIFESTYLE',
                                choices: [
                                    { text: 'Student living' },
                                    { text: 'Luxury rental' },
                                    { text: 'Assisted living' },
                                    { text: 'Retirement living' },
                                    { text: 'None of the above' }
                                ]
                            },
                            response: {
                                text: 'Where do you want to rent?',
                                input: {
                                    name: 'LOCATION',
                                    choices: [
                                        { text: 'Halifax South End' },
                                        { text: 'Halifax North End' },
                                        { text: 'Bedford' },
                                        { text: 'Clayton Park' },
                                        { text: 'Dartmouth' },
                                        { text: 'Cole Harbour' }
                                    ]
                                },
                                response: {
                                    text: 'In case we get disconnected, what is your email?',
                                    input: {
                                        type: 'email',
                                        name: 'EMAIL'
                                    },
                                    response: {
                                        text: 'What is your desired move-in date?',
                                        input: {
                                            name: 'MOVEIN',
                                            choices: [
                                                { text: 'January' },
                                                { text: 'February' },
                                                { text: 'March' },
                                                { text: 'April' },
                                                { text: 'May' },
                                                { text: 'June' },
                                                { text: 'July' },
                                                { text: 'August' },
                                                { text: 'September' },
                                                { text: 'October' },
                                                { text: 'November' },
                                                { text: 'December' }
                                            ]
                                        },
                                        response: {
                                            text: 'What is your approximate monthly budget?',
                                            input: {
                                                name: 'BUDGET',
                                                choices: [
                                                    { text: '500 - 1,000' },
                                                    { text: '1,000 - 1,250' },
                                                    { text: '1,250 - 1,500' },
                                                    { text: '1,500 - 1,750' },
                                                    { text: '1,750 - 2,000' },
                                                    { text: '2,000 - 2,250' },
                                                    { text: '2,250 - 2,500' },
                                                    { text: '2,500 - 2,750' },
                                                    { text: '2,750 - 3,000' },
                                                    { text: '3,000 - 4,000' },
                                                    { text: '4,000 - 5,000' },
                                                    { text: '5,000+' },
                                                ]
                                            },
                                            response: {
                                                text: 'What is the maximum monthly rent you are willing to pay?',
                                                input: {
                                                    type: 'number',
                                                    name: 'MAXBUDGET'
                                                },
                                                response: {
                                                    text: 'What is your employment status?',
                                                    input: {
                                                        name: 'EMPLOYMENT',
                                                        choices: [
                                                            { text: 'Student' },
                                                            { text: 'Employed' },
                                                            { text: 'Self-employed' },
                                                            { text: 'Unemployed' },
                                                            { text: 'Retired' },
                                                        ]
                                                    },
                                                    response: {
                                                        text: 'What is your approximate income?',
                                                        input: {
                                                            name: 'INCOME',
                                                            choices: [
                                                                { text: '0' },
                                                                { text: '10,000 - 20,000' },
                                                                { text: '20,000 - 30,000' },
                                                                { text: '30,000 - 50,000' },
                                                                { text: '50,000 - 100,000' },
                                                                { text: '100,000 - 300,000' },
                                                                { text: '> 300,000' },
                                                            ]
                                                        },
                                                        response: {
                                                            text: 'Do you have any pets?',
                                                            input: {
                                                                name: 'PETS',
                                                                choices: [
                                                                    { text: 'Yes' },
                                                                    { text: 'No' },
                                                                ]
                                                            },
                                                            response: {
                                                                text: 'What is your current home location?',
                                                                input: {
                                                                    type: 'location',
                                                                    name: 'ADDRESSNOW'
                                                                },
                                                                response: {
                                                                    text: 'What is your full name?',
                                                                    input: {
                                                                        type: 'text',
                                                                        name: 'FNAME'
                                                                    },
                                                                    response: {
                                                                        text: 'What is your preferred method of contact?',
                                                                        input: {
                                                                            name: 'CONTACTHOW',
                                                                            choices: [
                                                                                {
                                                                                    text: 'Email'
                                                                                },
                                                                                {
                                                                                    text: 'Call',
                                                                                    response: getPhone
                                                                                },
                                                                                {
                                                                                    text: 'Text',
                                                                                    response: getPhone
                                                                                }
                                                                            ]
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            });

        document.getElementById('container').appendChild(bot.element);
    </script>
</body>
</html>
